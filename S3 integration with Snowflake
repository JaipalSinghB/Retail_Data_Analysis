-- Integrating Snowflake to S3 bucket

create or replace storage integration Retail_data
Type = External_Stage
Enabled = True
Storage_Provider = S3
Storage_AWS_Role_Arn = 'arn:aws:iam::628143499237:role/Retail_role'
Storage_Allowed_Locations = ('s3://retaildata2');

desc storage integration Retail_data;
-- AFTER RUNNING ABOVE COMMAND COPY THE IAM USER ARN AND PASTE IT IN THE ROLE TRUST RELATIONSHIP OF AWS ACCOUNT

-- Creating Stage to temporary hold the data before loading to tables.

Create or replace stage Retail_data
URL = 's3://retaildata2'
FILE_FORMAT = retail_csv
STORAGE_INTEGRATION = retail_data;


SHOW stages;

LIST @Retail_data;

-- CREATING A PIPE THAT RECOGNIZES THE CSV FORMAT AND INGEST THE DATA FROM S3 BUCKET INTO TABLES
-- 1)
CREATE OR REPLACE PIPE CAMPAIGN_DESC_RAW
AUTO_INGEST = TRUE
AS COPY INTO "RETAIL"."PUBLIC"."CAMPAIGN_DESC_RAW"
FROM @Retail_data
FILE_FORMAT = retail_csv;

-- 2)
CREATE OR REPLACE PIPE CAMPAIGN_RAW
AUTO_INGEST = TRUE
AS COPY INTO "RETAIL"."PUBLIC"."CAMPAIGN_RAW"
FROM @Retail_data
FILE_FORMAT = retail_csv;

-- 3)
CREATE OR REPLACE PIPE COUPON_RAW
AUTO_INGEST = TRUE
AS COPY INTO "RETAIL"."PUBLIC"."COUPON_RAW"
FROM @Retail_data
FILE_FORMAT = retail_csv;

-- 4)
CREATE OR REPLACE PIPE COUPON_REDEMPT_RAW
AUTO_INGEST = TRUE
AS COPY INTO "RETAIL"."PUBLIC"."COUPON_REDEMPT_RAW"
FROM @Retail_data
FILE_FORMAT = retail_csv;

-- 5)
CREATE OR REPLACE PIPE DEMOGRAPHIC_RAW
AUTO_INGEST = TRUE
AS COPY INTO "RETAIL"."PUBLIC"."DEMOGRAPHIC_RAW"
FROM @Retail_data
FILE_FORMAT = retail_csv;

-- 6)
CREATE OR REPLACE PIPE PRODUCT_RAW
AUTO_INGEST = TRUE
AS COPY INTO "RETAIL"."PUBLIC"."PRODUCT_RAW"
FROM @Retail_data
FILE_FORMAT = retail_csv;

-- 7)
CREATE OR REPLACE PIPE TRANSACTION_RAW
AUTO_INGEST = TRUE
AS COPY INTO "RETAIL"."PUBLIC"."TRANSACTION_RAW"
FROM @Retail_data
FILE_FORMAT = retail_csv;


SHOW PIPES; -- TO SEE ALL THE PIPES WE HAVE CREATED

ALTER PIPE CAMPAIGN_DESC_RAW REFRESH;
ALTER PIPE CAMPAIGN_RAW REFRESH;
ALTER PIPE COUPON_RAW REFRESH;
ALTER PIPE COUPON_REDEMPT_RAW REFRESH;
ALTER PIPE DEMOGRAPHIC_RAW REFRESH;
ALTER PIPE PRODUCT_RAW REFRESH;
ALTER PIPE TRANSACTION_RAW REFRESH;




SELECT COUNT(*) FROM CAMPAIGN_DESC_RAW; -- 30 RECORDS

SELECT COUNT(*) FROM CAMPAIGN_RAW; -- 7208 RECORDS

SELECT COUNT(*) FROM COUPON_RAW; -- 249,096 RECORDS

SELECT COUNT(*) FROM COUPON_REDEMPT; --2318 RECORDS

SELECT COUNT(*) FROM DEMOGRAPHIC_RAW; -- 2500 RECORDS

SELECT COUNT(*) FROM PRODUCT_RAW; -- 92,353 RECORDS

SELECT COUNT(*) FROM TRANSACTIONS ; -- 2,595,732 RECORDS 
